<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css">
    </script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/messages/messages.es-es.js" type="text/javascript"></script>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/bs4/dt-1.10.20/r-2.2.3/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.20/r-2.2.3/datatables.min.js"></script>


    <title>Registrar Actividad</title>
</head>

<body>
    <form id="fm" class="border border-light p-5">
        <button class="btn btn-default" type="button" id="btnMenu">Volver al menu</button>
        <p class="h4 mb-4 text-center">Registrar Actividad</p>

        <label for="Activity">Actividad:</label>
        <select class="browser-default custom-select mb-4" id="Activity" name="Activity">
            <option value="C" selected="">Llamada Telefonica</option>
            <option value="M">Reunion</option>
            <option value="T">Tarea</option>
            <option value="E">Nota</option>
            <option value="P">Campaña</option>
            <option value="N">Otros</option>
        </select>

        <label for="ActivityType">Tipo:</label>
        <select class="browser-default custom-select mb-4" id="ActivityType" name="ActivityType">
            <option value="-1" selected="">General</option>
            <option value="1">Implementación</option>
            <option value="2">Consultoria</option>
            <option value="3">Comercial</option>
            <option value="4">Interna</option>
            <option value="5">Soporte</option>
            <option value="6">Administrativa</option>
            <option value="7">Cobranza</option>
            <option value="8">Desarrollo</option>
        </select>

        <label for="Subject">Asunto:</label>
        <select class="browser-default custom-select mb-4" id="Subject" name="Subject">
            <option value="-1" selected=""></option>
        </select> 

        <label for="CardCode">Codigo Socio Negocio:</label>
        <div class="input-group">
            <input type="text" id="CardCode" name="CardCode" class="form-control ">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button" id="btnZoom">...</button>
            </span>
        </div>
        <label for="CardName">Nombre Socio Negocio:</label>
        <input type="text" id="CardName" class="form-control mb-4" readonly=true>
        <label for="ContactPersonCode">Persona de contacto:</label>
        <select class="browser-default custom-select mb-4" id="ContactPersonCode" name="ContactPersonCode">
        </select>
        <label for="StartDate">Fecha inicio actividad:</label>
        <input type="text" id="StartDate" name="StartDate" class="form-control mb-4" autocomplete="off"
           >
        <label for="EndDueDate">Fecha termino actividad:</label>
        <input type="text" id="EndDueDate" name="EndDueDate" class="form-control mb-4" autocomplete="off" 
             placeholder="dd-mm-yyyy" >
        <label for="StartTime">Hora inicio actividad:</label>
        <input type="text" id="StartTime" name="StartTime" class="form-control mb-4"
            placeholder="Hora inicio actividad">
        <label for="EndTime">Hora termino actividad:</label>
        <input type="text" id="EndTime" name="EndTime" class="form-control mb-4"
            placeholder="Hora termino actividad">
      <!--  <label for="Duration">Duracion:</label>
        <input type="text" id="Duration" name="Duration" class="form-control mb-4">--> 

        <label for="U_Ubicacion">Ubicacion:</label>
        <select class="browser-default custom-select mb-4" id="U_Ubicacion" name="U_Ubicacion">
            <option value="" selected="">Remoto</option>
            <option value="Cliente">Cliente</option>
            <option value="VisualK">VisualK</option>
            <option value="SAP">SAP</option>
            <option value="Consultor">Consultor</option>
            <option value="Otro">Otro</option>
        </select>

        <label for="Details">Comentario:</label>
        <textarea  id="Details" name="Details" maxlength="100" rows="3" class="form-control mb-4" placeholder="Describa la actividad realizada..."></textarea>
        
        <button class="btn btn-info btn-block my-4" type="submit" id="btnSave">Crear</button>
        
    </form>
    <form id="ms" class="border border-light p-5">
        <p class="h4 mb-4 text-center">Buscar socio de negocio</p>
        <div class="input-group">
            <input type="text" id="Filter" class="form-control ">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button" id="btnSearch">Buscar</button>
                <button class="btn btn-default" type="button" id="btnClose">Cerrar</button>
            </span>
        </div>
        <div id="searchTable"></div>
    </form>
</body>

<script>

        
    

   // $("#server").val("hanab1vk:30015");

    (function ($) {
        $.fn.serializeFormJSON = function () {

            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };
    })(jQuery);

    $(document).on("click", "tr.rows td", function (e) {
        alert(e.target.innerHTML);
    });

    $(document).ready(function () {
        $("#ms").hide();

        $("#btnSave").click(function (e) {
            Add();
            e.preventDefault();
        });

        $("#btnZoom").click(function (e) {
            $("#fm").hide();
            $("#ms").show();
            removeTableHeader();
            removeTableBody();
            e.preventDefault();
        });

        $("#btnSearch").click(function (e) {
            removeTableHeader();
            removeTableBody();
            searchBusinessPartners()
            e.preventDefault();
        });

        $("#btnClose").click(function (e) {
            $("#ms").hide();
            $("#fm").show();
            e.preventDefault();
        });

        $("#btnMenu").click(function (e) {
            window.location.href = 'Home.html';
            e.preventDefault();
        });

        $("#CardCode").change(function (e) {
            CardCodeChanged();
            e.preventDefault();
        });

        $("#ActivityType").change(function (e){
           
            ActivityTypeChange();
            e.preventDefault();
        });

        window.onload=init;
        function init()
        {
            $("#StartDate").val(getDateFormat());  
            $("#EndDueDate").val(getDateFormat());
            //alert("cargando pagina");
            $("#StartTime").val(getHourFormat(0));
            $("#EndTime").val(getHourFormat(1));

            console.log(getHourFormat());
            
        }

        $('#StartDate').datepicker({
            locale: 'es-es',
            format: 'dd-mm-yyyy',
            uiLibrary: 'bootstrap',
            ishowOnFocus: true,
            showRightIcon: false
        });

        $('#EndDueDate').datepicker({
            locale: 'es-es',
            format: 'dd-mm-yyyy',
            uiLibrary: 'bootstrap',
            ishowOnFocus: true,
            showRightIcon: false,
            startDate: getDateFormat()
        });
  

        $('#StartTime').timepicker({
            timeFormat: 'h:mm p',
            interval: 60,
            minTime: '8',
            maxTime: '7:00pm',
            defaultTime: '9',
            startTime: '9',
            dynamic: false,
            dropdown: true,
            scrollbar: true,
            super:true
        });

        $('#EndTime').timepicker({
            timeFormat: 'h:mm p',
            interval: 60,
            minTime: '8',
            maxTime: '7:00pm',
            defaultTime: '10',
            startTime: '10',
            dynamic: false,
            dropdown: true,
            scrollbar: true
        });

    });

    function Add() {
        var json = $('#fm').serializeFormJSON();
        var jsonStr = JSON.stringify(json);
        console.log(jsonStr);
        jQuery.ajax({
            type: 'post',
            dataType: "text",
            contentType: 'application/text',
            url: 'AddActivity',
            async: false,
            timeout: 15000,
            data: jsonStr
        }).done(function (result) {
            //alert(data);
            if (result.startsWith("error:")) {
                alert(result.replace("error:", ""));
            } else {
                var o = JSON.parse(result);
                //let json = result.serializeFormJSON;
                console.log(o.ActivityCode);
                alert("Actividad registrada en SAP codigo: " + o.ActivityCode); //indicar ID de la activiad
                window.location.href = 'Home.html';
            }           
        });
    }

    function CardCodeChanged() {
        
        if ($("#CardCode").val() == "") {
            $("#CardName").val("");
            $('#ContactPersonCode').find('option').remove();
            return;
        }
        jQuery.ajax({
            type: 'post',
            dataType: "text",
            contentType: 'application/text',
            url: 'GetBusinessPartner',
            async: true,
            data: $("#CardCode").val()
        }).done(function (result) {
            //alert(data);
            if (result.startsWith("error:")) {
                alert(result.replace("error:", ""));
            } else {
                var r = JSON.parse(result);
                $("#CardName").val(r.CardName);
                jQuery.ajax({
                    type: 'post',
                    dataType: "text",
                    contentType: 'application/text',
                    url: 'GetBusinessPartnerContactEmployes',
                    async: true,
                    data: $("#CardCode").val()
                }).done(function (result) {
                    //alert(data);
                    if (result.startsWith("error:")) {
                        alert(result.replace("error:", ""));
                    }
                    else {
                        var r = JSON.parse(result);
                        var $select = $('#ContactPersonCode');
                        $select.find('option').remove();
                        for (var i = 0; i < r.ContactEmployees.length; i++) {
                            var record = r.ContactEmployees[i];
                            $select.append('<option value=' + record.InternalCode + '>' + record.Name + '</option>');
                        }
                    }
                });
            }
        });

    }


    function ActivityTypeChange(){
        console.log("CAMBIO TIPO ACTIVIDAD:" + $("#ActivityType").val());
        //$('#ActivityType').find('option').remove();

        jQuery.ajax({
                    type: 'post',
                    dataType: "text",
                    contentType: 'application/text',
                    url: 'GetActivitySubjects',
                    async: true,
                    data: $("#ActivityType").val()
                }).done(function (result) {
                    if (result.startsWith("error:")) {
                        alert(result.replace("error:", ""));
                    }
                    else {
                        var r = JSON.parse(result);
                        console.log(r);
                        var $select = $('#Subject');
                        $select.find('option').remove();
                        for (var i = 0; i < r.value.length; i++) {
                            var record = r.value[i];
                            $select.append('<option value=' + record.Code + '>' + record.Description + '</option>');
                        }
                    }
                });

    }

    function selectRow(CardCode) {
        //alert(CardCode);
        $("#CardCode").val(CardCode);
        $("#ms").hide();
        $("#fm").show();
        CardCodeChanged();
    }

    function removeTableHeader()
    {
        $('#tableSearch thead').empty(); 
    }

    function removeTableBody(){
        $('#tableSearch tbody').empty();
    }


    function getDateFormat() {
        var d = new Date();
        var m = d.getMonth() + 1;
        var mes = (m < 10) ? '0' + m : m;
        var result = d.getDate() + "-" + mes + "-" + d.getFullYear();
        return result;
    }

    function getHourFormat(aditional)
    {
        var hour = new Date();
        var h;
        if (aditional > 0)
            h = hour.getHours() + aditional;
        else
            h = hour.getHours();

        var horario;

        if (h<12)
            horario = "AM";
        else
            horario = "PM";
        return (h.toString()+ ":00 "+horario);
    }

    function searchBusinessPartners() {
        
        $("#btnSearch").prop("disabled", true);
        jQuery.ajax({
            type: 'post',
            dataType: "text",
            contentType: 'application/text',
            url: 'GetBusinessPartners',
            async: true,
            data: $("#Filter").val()
        }).done(function (result) {
            //alert(data);
            $("#btnSearch").prop("disabled", false);
            if (result.startsWith("error:")) {
                alert(result.replace("error:", ""));
            }
            else {
                var r = JSON.parse(result);
                var t = $('<table id=tableSearch><thead><th>Codigo</th><th>Nombre</th></thead><tbody></tbody></table>').addClass('table table-striped');
                //var t = $('<table id=tableSearch><thead><tr><th>Codigo</th><th>Nombre</th></tr></thead></table>').addClass('table table-striped');
               // var tbody = $('<tbody></tbody>');  //desc
               // table.append(tbody);               //desc

                for (var i = 0; i < r.value.length; i++) {
                    var record = r.value[i];
                    var row = "<tr id='@0' onclick='selectRow(\"@1\")'><td style='cursor:pointer'>@1</td><td style='cursor:pointer'>@2</td>";
                    row = row.replace(/@0/g, "tr_" + i).replace(/@1/g, record.CardCode).replace(/@2/g, record.CardName);
                    t.append(row);
                }
                $('#searchTable').append(t);
            }
        });
    }


    
</script>

</html>